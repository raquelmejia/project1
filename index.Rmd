---
title: 'Project 1: Data Wrangling, Exploration, Visualization'
author: "Raquel Mejia  |  rm57578"
date: 'SDS322E'
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
    theme: cosmo
    highlight: textmate
  pdf_document:
    toc: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, fig.align = "center", warning = F, message = F,
tidy=TRUE, tidy.opts=list(width.cutoff=60), R.options=list(max.print=100))
```
<br>
<br>

Introduction
=============
<br>
The purpose of this project was to apply data wrangling skills to two datasets with a shared identification variable, join these two datasets based on their shared identification variable, and then explore and visualize relationships within the joined dataset. 
<br>
<br>
I examined a [Preliminary Assisted Reproductive Technology (ART) Report from 2019](https://www.cdc.gov/art/artdata/index.html#preliminary) that was published by the Centers for Disease and Control and Prevention. This dataset contains information about fertility clinics in the U.S. that reported data on the treatment cycles that they performed in 2019, reasons for treatment, live birth and success rates, and miscellaneous clinic data, such as available treatment options/clinic location/whether or not the clinic is a member of the Society of American Reproductive Technology (SART). 
<br>
<br>
The CDC describes ART as follows: *"ART includes all fertility treatments in which either eggs or embryos are handled.  The main type of ART is in vitro fertilization (IVF). IVF involves extracting a womanâ€™s eggs, fertilizing the eggs in the laboratory, and then transferring the resulting embryos."*
<br>
<br>
The variables analyzed from this dataset are:  

  (1) Total number of treatment cycles of patients of all ages <br>
  (2) Percent of embryo transfers involving at least one embryo with Pre-implantation Genetic Testing <br>
  (3) Status of a clinic as a member of SART <br>

<br>
The second dataset that was examined was the [U.S. Median Annual Household Income in 2019](https://www.kff.org/other/state-indicator/median-annual-income/?currentTimeframe=0&sortModel=%7B%22colId%22:%22Location%22,%22sort%22:%22asc%22%7D#notes) gathered from the U.S. Census Bureau and downloaded from the Kaiser Family Foundation website. 
<br>
<br>
The variable analyzed from this dataset includes:

  (1) Median annual household income from 2019
<br>
```{R}
library(tidyverse)
library(kableExtra)
library(knitr)
library(usmap)

medincome2019 <- read_csv("/stor/home/rm57578/project1/datasets/medincome2019.csv")
prelimivf2019 <- read_csv("/stor/home/rm57578/project1/datasets/prelimivf2019.csv")

```


Joining/Merging
====================

The 2019 Median Annual Household Income dataset, `medincome2019`, has 53 total and unique rows/observations: the median incomes of all 50 U.S. states, District of Columbia, Puerto Rico, and the median U.S Household income. This dataset has two variables: location and median annual household income. 
```{r, collapse = T}
n_distinct(medincome2019) 
nrow(medincome2019) 
ncol(medincome2019)
```
<br>
The 2019 Prelim ART dataset, `prelimivf2019`, has 448 total and unique rows/observations, representing 448 unique fertility clinics that reported their ART data to the CDC in 2019. This dataset has 140 variables. 
```{r, collapse = T}
n_distinct(prelimivf2019) 
nrow(prelimivf2019) 
ncol(prelimivf2019)
```
<br>
The locations in the `medincome2019` dataset were replaced by uppercase locations (now named `joinmedincome2019`) to prepare to join with the uppercase clinic locations in the `prelimivf2019` dataset. 
```{R}
medincome2019 %>% mutate(location = str_replace(Location, ".+", toupper)) %>% select(location, "Median Annual Household Income") -> joinmedincome2019
```
<br>
All clinic locations in the `prelimivf2019` dataset can be found as locations in the `joinmedincome2019` dataset. 
<br>
Four locations in the `joinmedincome2019` dataset are not present in the `prelimivf2019` dataset. The following locations are not listed as the current location of a fertility clinic in the `prelimivf2019` dataset: United States, Alaska, New Hampshire, and Wyoming. 
```{R, collapse=T}
anti_join(prelimivf2019, joinmedincome2019, by = c("CurrentClinicState" = "location")) %>% nrow() 

anti_join(joinmedincome2019, prelimivf2019, by = c("location" = "CurrentClinicState")) 
```
<br>
The `prelimivf2019` and `joinmedincome2019` datasets have 49 locations in common, listed below. These 49 location are shared identification variables that will be used to join the datasets together. 
```{R, collapse=T}
semi_join(joinmedincome2019, prelimivf2019, by = c("location" = "CurrentClinicState")) %>% nrow() 

prelimivf2019 %>% distinct(CurrentClinicState) %>% semi_join(joinmedincome2019, by = c("CurrentClinicState" = "location")) %>% as.list 
```
<br>
The two datasets were joined using a left join onto the `prelimivf2019` dataset. By doing so, the entire `prelimivf2019` dataset was preserved, and the median annual household incomes of the locations of fertility clinics were added as a new column to the joined dataset, `ivfincome`. A left join was performed because I was only interested in the median incomes of locations that had clinics that reported ART data to the CDC in 2019. 
<br>
<br>
As a result of this left join, the `ivfincome` dataset has the same number of observations as the `prelimivf2019` dataset. 
```{R}
left_join(prelimivf2019, joinmedincome2019, by = c("CurrentClinicState" = "location")) -> ivfincome 
ivfincome %>% nrow() 
```
<br>
The four locations from the `joinmedincome2019` dataset that were not part of the `prelimivf2019` dataset were removed, which is helpful because there is no clinic data for these locations, so these locations would not be helpful when analyzing relationships between clinic location and income. 
<br>

Wrangling
=========
<br>
The data wrangling below will focus on preparing and analyzing the following variables: 

  (1) the median annual household income of the location of the fertility clinic (`Median Annual Household Income`) <br>
  (2) a clinic's total number of treatment cycles in 2019 (`TotNumCyclesAll`) <br>
  (3) a clinic's status as a SART member in 2019 (`SARTmember`) <br>
  (4) a clinic's percent of embryo transfers that had at least one embryo with Pre-implantation Genetic Testing (`TransPGTAll`)

For simplicity, `CurrentClinicState` was renamed to `state`, and `Median Annual Household Income` was renamed to `medianincome`. 
<br>
<br>
In the `medianincome` column, all dollar signs and commas were removed and the incomes were recoded as integers instead of characters. 
```{r}
ivfincome %>% 
  rename("state" = "CurrentClinicState") %>%
  rename("medianincome" = "Median Annual Household Income" ) %>%
  mutate(medianincome = str_replace_all(medianincome, "[$,]*[$,]*","")) %>%
  mutate(medianincome = as.integer(medianincome)) -> ivfincome
```
<br>
Fertility clinics were placed into groupings based off of their location (usually state, except for D.C. and Puerto Rico). The following summary statistics were calculated for each location: 

  (1) Total treatment cycles performed by all fertility clinics in that location (`totalivfcycles`) <br>
  (2) Median number of treatment cycles performed by all fertility clinics in that location (`medianivfcycles`) <br>
  (3) Mean number of treatment cycles performed by all fertility clinics in that location (`meanivfcycles`) <br>
  (4) Standard deviation of treatment cycles performed by all fertility clinics in that location (`sdivfcycles`) <br>
```{R, FINISHED1}
ivfincome %>%
  group_by(state) %>%
  summarise("totalivfcycles" = sum(TotNumCyclesAll), 
            "medianivfcycles" = median(TotNumCyclesAll), 
            "meanivfcycles" = mean(TotNumCyclesAll), 
            "sdivfcycles" = sd(TotNumCyclesAll)) -> summarieslocations
```
<br>
Fertility clinics in California, New York, and Texas performed the most treatment cycles in 2019, respectively, with CA performing 57,491 total treatment cycles, NY performing 51,716 treatment cycles, and TX performing 25,287 treatment cycles. 
<br>
Rhode Island, Idaho, and Kentucky performed the least treatment cycles in 2019, with RI performing 862 treatment cycles, ID performing 822 treatment cycles, and KY performing 764 treatment cycles. 
```{r}
summarieslocations %>%
  arrange(-totalivfcycles) %>% 
  slice(1:3, 37:39) %>%
  kable()
```
<br>
Fertility clinics in North-Eastern states have the four highest mean treatment cycles and standard deviation of treatment cycles. 
```{r, collapse=T}
summarieslocations %>% 
  arrange(-meanivfcycles) %>% 
  slice(1:4) %>%
  kable()
  
summarieslocations %>% 
  arrange(-sdivfcycles) %>% 
  slice(1:4) %>%
  kable()
```
<br>
<br>
A new variable that describes a clinic's total number of transfers with at least one embryo with Pre-implantation Genetic Testing was accomplished by multiplying the total number of embryo transfers that a clinic performed by the percent of transfers with at least one PGT embryo. 
<br>
<br>
The total number of embryo transfers was calculated by adding eight variables together. The first four of these variables begin with `ND_NumTrans` and describe embryo transfers that used a non-donor egg (four variables that each correspond to a patient age group). The other four of these variables begin with `Donor_NumTrans` and describe embryo transfers that used a donor egg (four variables that each correspond to a patient age group). 
<br>
<br>
Some extremely small clinics had asterisks that suppressed data to preserve patient confidentiality. Rows with asterisks were removed for these calculations. Commas were removed from observations that had embryo transfers greater than 999, and afterwards all eight variables were converted from characters to integers. Additionally, the percent symbol was removed from the `TransPGTAll` variable, and it was then also converted from characters to integers. 
```{r}
ivfincome %>%
  mutate(ND_NumTrans1 = na_if(ND_NumTrans1, "*")) %>%
  mutate(ND_NumTrans2 = na_if(ND_NumTrans2, "*")) %>%
  mutate(ND_NumTrans3 = na_if(ND_NumTrans3, "*")) %>%
  mutate(ND_NumTrans4 = na_if(ND_NumTrans4, "*")) %>%
  mutate(Donor_NumTrans1 = na_if(Donor_NumTrans1, "*")) %>%
  mutate(Donor_NumTrans2 = na_if(Donor_NumTrans2, "*")) %>%
  mutate(Donor_NumTrans3 = na_if(Donor_NumTrans3, "*")) %>%
  mutate(Donor_NumTrans4 = na_if(Donor_NumTrans4, "*")) %>%
  mutate(ND_NumTrans1 = str_replace_all(ND_NumTrans1, ",", "")) %>%
  mutate(ND_NumTrans2 = str_replace_all(ND_NumTrans2, ",", "")) %>%
  mutate(ND_NumTrans3 = str_replace_all(ND_NumTrans3, ",", "")) %>%
  mutate(ND_NumTrans4 = str_replace_all(ND_NumTrans4, ",", "")) %>%
  mutate(Donor_NumTrans1 = str_replace_all(Donor_NumTrans1, ",", "")) %>%
  mutate(Donor_NumTrans2 = str_replace_all(Donor_NumTrans2, ",", "")) %>%
  mutate(Donor_NumTrans3 = str_replace_all(Donor_NumTrans3, ",", "")) %>%
  mutate(Donor_NumTrans4 = str_replace_all(Donor_NumTrans4, ",", "")) %>%
  mutate(ND_NumTrans1 = as.integer(ND_NumTrans1)) %>%
  mutate(ND_NumTrans2 = as.integer(ND_NumTrans2)) %>%
  mutate(ND_NumTrans3 = as.integer(ND_NumTrans3)) %>%
  mutate(ND_NumTrans4 = as.integer(ND_NumTrans4)) %>%
  mutate(Donor_NumTrans1 = as.integer(Donor_NumTrans1)) %>%
  mutate(Donor_NumTrans2 = as.integer(Donor_NumTrans2)) %>%
  mutate(Donor_NumTrans3 = as.integer(Donor_NumTrans3)) %>%
  mutate(Donor_NumTrans4 = as.integer(Donor_NumTrans4)) %>%
  mutate(TransPGTAll = na_if(TransPGTAll, "*")) %>%
  mutate(TransPGTAll = str_replace_all(TransPGTAll, "%", "")) %>%
  mutate(TransPGTAll = as.numeric(TransPGTAll)) -> ivfincome
```
<br>
After creating a variable that describes a clinic's total number of transfers with at least one PGT embryo (`cyclesatleastonePGT`), clinics were grouped by location so that the average number of transfers with at least one PGT embryo could be summarized for each location. 
<br>
```{r}
ivfincome %>% 
  group_by(CurrentClinicName1) %>%
  mutate("totaltransfers" = sum(Donor_NumTrans1, Donor_NumTrans2, Donor_NumTrans3, Donor_NumTrans4, ND_NumTrans1, ND_NumTrans2, ND_NumTrans3, ND_NumTrans4, na.rm=T)) %>% 
  mutate("cyclesatleastonePGT" = (TransPGTAll/100)*totaltransfers) %>% 
  group_by(state) %>% 
  mutate("statecycPGT" = mean(cyclesatleastonePGT, na.rm=T)) -> statecycPGTdata
```
<br>

```{r}
statecycPGTdata %>%
  group_by(state) %>% 
  arrange(-statecycPGT) %>%
  slice(1:3, 37:39)
```
If applicable, at least 1 of these should group by two categorical variables
```{R, FINISHED2}
ivfincome %>%   
  group_by(state, SARTmember) %>% summarise(countsclinicSARTmember = n()) #number of clinics that are and aren't SART members by state
```

```{R, FINISHED4}
ivfincome %>%   
  filter(medianincome > 65712) %>% nrow() #231 clinics are located in states with a median income higher than the median income of the U.S.: $65,712. 

ivfincome %>%   
  filter(medianincome > 65712) %>% summarise(meantotalcycles = mean(TotNumCyclesAll)) #Clinics in a state with a median income higher than the median income of the U.S. performed an average of 937 IVF cycles in 2019. 

ivfincome %>%   
  filter(medianincome < 65712) %>% nrow()#217 clinics are located in states with a median income lower than the median income of the U.S.: $65,712. 

ivfincome %>%   
  filter(medianincome < 65712) %>% summarise(meantotalcycles = mean(TotNumCyclesAll)) #Clinics in a state with a median income higher than the median income of the U.S. performed an average of 526 IVF cycles in 2019. 
```

Tidying: Reshaping
=======================
Used pivot_wider to tidy summary data (counts of clinics in each state, categorized by below/above US median income)
```{R, FINISHED3}
ivfincome %>% 
  mutate("aboveUSmedian" = ifelse(medianincome>65712, "Above Median U.S. Income", "Below Median U.S. Income")) %>%
  group_by(state, aboveUSmedian) %>% 
  summarise("countaboveUSmedian" = n()) %>%
  pivot_wider(names_from="aboveUSmedian",values_from="countaboveUSmedian")

```

Visualizing
================
```{R, FINISHED5}
ivfincome %>%
  group_by(state) %>%
  mutate("medianivfcycles" = median(TotNumCyclesAll)) %>% 
  
  ggplot(aes(x=medianincome, y=medianivfcycles)) + 
  geom_point(shape = 1, size=3.5) + 
  geom_smooth(method = "lm", col="skyblue") +
  theme_minimal() +
  theme(plot.title = element_text(size=17), 
        axis.title.x = element_text(margin=margin(15,0,0,0)), 
        axis.title.y = element_text(margin=margin(0,12,0,0)),)+
  labs(title="Effect of Income on Number of IVF Cycles", 
       subtitle="Plot represents the median annual household income of a state* and \nthe median number of IVF cycles that clinics in that state performed in 2019.", 
       caption = "*D.C. and Puerto Rico are included") +
  scale_x_continuous(name = "Median Annual Household Income of State", 
                     labels=scales::dollar_format(), 
                     breaks = seq(20000,100000, by=10000)) +
  scale_y_continuous(name = "Median Number of IVF Cycles", 
                     labels=scales::comma, 
                     breaks = seq(0, 1200, by=100))
```
^^Your discussion of plot 1
```{R}
ivfincome %>% 
  mutate("aboveUSmedian" = ifelse(medianincome>65712, "Above Median U.S. Income", "Below Median U.S. Income")) %>%
  group_by(state) %>%
  mutate("meanivfcycles" = mean(TotNumCyclesAll)) -> medianUSincome


medianUSincome %>% 
  ggplot(aes(x = aboveUSmedian, y = meanivfcycles, fill=aboveUSmedian))+
  geom_bar(stat="summary",fun=mean, width=0.6)+
  geom_errorbar(stat="summary", fun.data=mean_se, width = 0.3) +
  theme_minimal() +
  theme(plot.title = element_text(size=15), 
        axis.title.x = element_text(margin=margin(15,0,0,0)), 
        axis.title.y = element_text(margin=margin(0,12,0,0)),
        legend.position = "none") +
  labs(title="IVF Cycles Relative to Median U.S. Income", 
       subtitle="Plot represents the average number of IVF cycles performed by clinics in states* that are \nabove and below the median U.S. income in 2019 ($65,712).", 
       caption = "*D.C. and Puerto Rico are included") + 
  xlab(" ") +
  scale_y_continuous(name = "Average Number of IVF Cycles", 
                     labels=scales::comma, 
                     breaks = seq(0, 1000, by=100)) +
  scale_fill_manual(values=c("#869E81", "#BD5E4B"))


```
^^Your discussion of plot 2


Median or mean? What am i trying to show?
```{R}
ivfincome %>%
 group_by(state) %>%
 mutate("medianivfcycles" = median(TotNumCyclesAll)) -> medivfincome  

 plot_usmap(data = medivfincome, values = "medianivfcycles", regions = "states", col="white") +
   labs(title = "Median Number of IVF Cycles Across the U.S.", 
        subtitle = "This map shows the median number of IVF cycles that clinics in that state performed in 2019.", 
        caption="Alaska, New Hampshire, and Wyoming did not report any IVF cycles in 2019 (shown as grey).") +
   scale_fill_continuous(low = "skyblue", high = "skyblue4", name = "Total IVF Cycles", label = scales::comma) + 
   theme(legend.position = "right", plot.title = element_text(hjust = 0.5, size=15))

```

Your discussion of plot 2


For plot: total number of cycles per state with at least one PGT vs. median income 


includes variable thats a function of other variable 
```{R, FINISHED6}
ivfincome %>% group_by(CurrentClinicName1) %>%
  mutate("totaltransfers" = sum(Donor_NumTrans1, Donor_NumTrans2, Donor_NumTrans3, Donor_NumTrans4, ND_NumTrans1, ND_NumTrans2, ND_NumTrans3, ND_NumTrans4, na.rm=T)) %>% 
  mutate("cyclesatleastonePGT" = (TransPGTAll/100)*totaltransfers) %>% 
  group_by(state) %>% 
  mutate("statecycPGT" = mean(cyclesatleastonePGT, na.rm=T))%>% 
  
  ggplot(aes(x=medianincome, y=statecycPGT)) + 
  geom_point(shape = 1, size=3.5) + 
  geom_smooth(method = "lm") +
  theme_minimal() +
  theme(plot.title = element_text(size=15), 
        axis.title.x = element_text(margin=margin(15,0,0,0)), 
        axis.title.y = element_text(margin=margin(0,12,0,0)),)+
  labs(title="Effect of Income on Genetic Testing", 
       subtitle="Plot represents the median annual household income of a state* and \nthe average number of transfers of at least one embryo with genetic testing \nthat clinics in that state performed in 2019.", 
       caption = "*D.C. and Puerto Rico are included") +
  scale_x_continuous(name = "Median Annual Household Income of State", 
                     labels=scales::dollar_format(), 
                     breaks = seq(20000,100000, by=10000)) +
  scale_y_continuous(name = "Average Number of Transfers \nwith at least one PGT Embryo", 
                     labels=scales::comma, 
                     breaks = seq(0, 500, by=100))
```

Your discussion of plot 3

old vs young patients vs income
```{R}


```


Your discussion of plot 4

Concluding Remarks
==================

If any!
wealth disparity! infertility should be covered under insurance! 




